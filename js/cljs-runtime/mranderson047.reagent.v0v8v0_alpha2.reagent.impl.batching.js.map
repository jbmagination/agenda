{"version":3,"sources":["mranderson047/reagent/v0v8v0_alpha2/reagent/impl/batching.cljs"],"sourcesContent":["(ns mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching\n  (:refer-clojure :exclude [flush])\n  (:require [mranderson047.reagent.v0v8v0-alpha2.reagent.debug :refer-macros [dbg assert-some]]\n            [mranderson047.reagent.v0v8v0-alpha2.reagent.interop :refer-macros [$ $!]]\n            [mranderson047.reagent.v0v8v0-alpha2.reagent.impl.util :refer [is-client]]\n            [clojure.string :as string]))\n\n;;; Update batching\n\n(defonce mount-count 0)\n\n(defn next-mount-count []\n  (set! mount-count (inc mount-count)))\n\n(defn fake-raf [f]\n  (js/setTimeout f 16))\n\n(def next-tick\n  (if-not is-client\n    fake-raf\n    (let [w js/window]\n      (or ($ w :requestAnimationFrame)\n          ($ w :webkitRequestAnimationFrame)\n          ($ w :mozRequestAnimationFrame)\n          ($ w :msRequestAnimationFrame)\n          fake-raf))))\n\n(defn compare-mount-order [c1 c2]\n  (- ($ c1 :cljsMountOrder)\n     ($ c2 :cljsMountOrder)))\n\n(defn run-queue [a]\n  ;; sort components by mount order, to make sure parents\n  ;; are rendered before children\n  (.sort a compare-mount-order)\n  (dotimes [i (alength a)]\n    (let [c (aget a i)]\n      (when (true? ($ c :cljsIsDirty))\n        ($ c forceUpdate)))))\n\n\n;; Set from ratom.cljs\n(defonce ratom-flush (fn []))\n\n(deftype RenderQueue [^:mutable ^boolean scheduled?]\n  Object\n  (enqueue [this k f]\n    (assert-some f \"Enqueued function\")\n    (when (nil? (aget this k))\n      (aset this k (array)))\n    (.push (aget this k) f)\n    (.schedule this))\n\n  (run-funs [this k]\n    (when-some [fs (aget this k)]\n      (aset this k nil)\n      (dotimes [i (alength fs)]\n        ((aget fs i)))))\n\n  (schedule [this]\n    (when-not scheduled?\n      (set! scheduled? true)\n      (next-tick #(.run-queues this))))\n\n  (queue-render [this c]\n    (.enqueue this \"componentQueue\" c))\n\n  (add-before-flush [this f]\n    (.enqueue this \"beforeFlush\" f))\n\n  (add-after-render [this f]\n    (.enqueue this \"afterRender\" f))\n\n  (run-queues [this]\n    (set! scheduled? false)\n    (.flush-queues this))\n\n  (flush-after-render [this]\n    (.run-funs this \"afterRender\"))\n\n  (flush-queues [this]\n    (.run-funs this \"beforeFlush\")\n    (ratom-flush)\n    (when-some [cs (aget this \"componentQueue\")]\n      (aset this \"componentQueue\" nil)\n      (run-queue cs))\n    (.flush-after-render this)))\n\n(defonce render-queue (->RenderQueue false))\n\n(defn flush []\n  (.flush-queues render-queue))\n\n(defn flush-after-render []\n  (.flush-after-render render-queue))\n\n(defn queue-render [c]\n  (when-not ($ c :cljsIsDirty)\n    ($! c :cljsIsDirty true)\n    (.queue-render render-queue c)))\n\n(defn mark-rendered [c]\n  ($! c :cljsIsDirty false))\n\n(defn do-before-flush [f]\n  (.add-before-flush render-queue f))\n\n(defn do-after-render [f]\n  (.add-after-render render-queue f))\n\n(defn schedule []\n  (when (false? (.-scheduled? render-queue))\n    (.schedule render-queue)))\n"],"mappings":"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","names":["js/mranderson047","js/mranderson047.reagent","js/mranderson047.reagent.v0v8v0-alpha2","js/mranderson047.reagent.v0v8v0-alpha2.reagent","js/mranderson047.reagent.v0v8v0-alpha2.reagent.impl","js/mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching","js/mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching.mount-count","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/mount-count","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/next-mount-count","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/fake-raf","f","js/setTimeout","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/next-tick","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.util/is-client","w","js/window","or__3949__auto__","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/compare-mount-order","c1","c2","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/run-queue","a","n__4408__auto__","i","c","js/mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching.ratom-flush","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/ratom-flush","this__4192__auto__","writer__4193__auto__","opt__4194__auto__","cljs.core/-write","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/RenderQueue","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/->RenderQueue","scheduled?","this","k","js/Error","temp__5461__auto__","fs","fexpr__18303","G__18308","cs","js/mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching.render-queue","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/render-queue","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/flush","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/flush-after-render","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/queue-render","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/mark-rendered","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/do-before-flush","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/do-after-render","mranderson047.reagent.v0v8v0-alpha2.reagent.impl.batching/schedule"]}